<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Analyzer</title>
    <script>
      (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyBx-GxqNHFZ0Hg7csJuucTqK8GZVDc9yPg",
        v: "weekly"
      });
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useRef } = React;

const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000' : '';

function RealEstateAnalyzer() {
  const [propertyData, setPropertyData] = useState({
    address: '',
    purchasePrice: '',
    currentSqft: '',
    beds: '3',
    baths: '2',
    lotSize: '0.25',
    yearBuilt: '2000',
    zestimate: 0,
    rent_zestimate: 0,
    latitude: null,
    longitude: null,
    zillow_url: '',
    image_url: '',
    status: ''
  });
  
  const [compsData, setCompsData] = useState([]);
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(false);
  const [fetchingProperty, setFetchingProperty] = useState(false);
  const [error, setError] = useState(null);
  const addressInputRef = useRef(null);
  const autocompleteRef = useRef(null);

  // FIXED: Modern Autocomplete Setup
  useEffect(() => {
    const startGoogle = async () => {
      const { Autocomplete } = await google.maps.importLibrary("places");
      
      if (addressInputRef.current) {
        autocompleteRef.current = new Autocomplete(addressInputRef.current, {
          types: ['address'],
          componentRestrictions: { country: 'us' },
          fields: ['formatted_address', 'geometry']
        });

        autocompleteRef.current.addListener('place_changed', async () => {
          const place = autocompleteRef.current.getPlace();
          if (place.formatted_address) {
            const address = place.formatted_address;
            setPropertyData(prev => ({ ...prev, address: address }));
            await fetchPropertyAndComps(address);
          }
        });
      }
    };

    startGoogle();
  }, []);

  const fetchPropertyAndComps = async (address) => {
    setFetchingProperty(true);
    setError(null);
    setCompsData([]);
    
    try {
      const response = await fetch(`${API_URL}/api/lookup-property`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        const subject = data.subject;
        setPropertyData(prev => ({
          ...prev,
          currentSqft: subject.sqft || prev.currentSqft,
          beds: subject.beds || prev.beds,
          baths: subject.baths || prev.baths,
          lotSize: subject.lot_size || prev.lotSize,
          yearBuilt: subject.year_built || prev.yearBuilt,
          zestimate: subject.zestimate || 0,
          rent_zestimate: subject.rent_zestimate || 0,
          latitude: subject.latitude,
          longitude: subject.longitude,
          zipcode: subject.zipcode,
          zillow_url: subject.zillow_url || '',
          image_url: subject.image_url || '',
          status: subject.status || ''
        }));
        
        setCompsData(data.comps || []);
        console.log('‚úÖ Property + comps loaded:', data);
      } else {
        setError('Property not found. Please enter details manually.');
      }
    } catch (err) {
      console.error('Error fetching property:', err);
      setError('Unable to fetch property details. Please try again.');
    } finally {
      setFetchingProperty(false);
    }
  };

  const handleInputChange = (e) => {
    setPropertyData({
      ...propertyData,
      [e.target.name]: e.target.value
    });
  };

  const analyzeProperty = async () => {
    setLoading(true);
    setError(null);
    try {
      const analysisData = { ...propertyData, comps: compsData };
      const response = await fetch(`${API_URL}/api/analyze`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(analysisData)
      });
      const data = await response.json();
      if (response.ok) { setResults(data); } else { setError(data.error || 'Analysis failed'); }
    } catch (err) {
      setError('Cannot connect to API. Make sure the server is running!');
    } finally {
      setLoading(false);
    }
  };

  const downloadPDF = async () => {
    try {
      const response = await fetch(`${API_URL}/api/report/pdf`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(results)
      });
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${propertyData.address.replace(/\s/g, '_')}_Analysis.pdf`;
      a.click();
    } catch (err) { alert('PDF generation failed'); }
  };

  const downloadExcel = async () => {
    try {
      const response = await fetch(`${API_URL}/api/report/excel`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(results)
      });
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${propertyData.address.replace(/\s/g, '_')}_Analysis.xlsx`;
      a.click();
    } catch (err) { alert('Excel generation failed'); }
  };

  return (
    <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '20px', fontFamily: 'Arial, sans-serif' }}>
      <h1 style={{ textAlign: 'center', color: '#2c3e50' }}>Real Estate Investment Analyzer</h1>
      
      <div style={{ background: '#f8f9fa', padding: '20px', borderRadius: '8px', marginBottom: '20px' }}>
        <h2>Property Lookup</h2>
        <div style={{ marginBottom: '15px' }}>
          <label style={{ display: 'block', marginBottom: '5px', fontWeight: 'bold' }}>Address</label>
          <input
            ref={addressInputRef}
            name="address"
            value={propertyData.address}
            onChange={handleInputChange}
            placeholder="Start typing address..."
            style={{ width: '100%', padding: '12px', borderRadius: '4px', border: '1px solid #ddd', fontSize: '16px' }}
            autoComplete="off"
          />
        </div>
        {fetchingProperty && (
          <div style={{ background: '#e3f2fd', padding: '15px', borderRadius: '4px', color: '#1976d2', textAlign: 'center' }}>
            üîç Loading property details and comparable sales...
          </div>
        )}
      </div>

      {propertyData.zestimate > 0 && (
        <>
          <div style={{ background: '#fff', border: '2px solid #4caf50', borderRadius: '8px', padding: '20px', marginBottom: '20px' }}>
            <h2 style={{ marginTop: 0, color: '#2e7d32' }}>Subject Property</h2>
            <div style={{ display: 'flex', gap: '20px', marginBottom: '15px' }}>
              {propertyData.image_url && (
                <a href={propertyData.zillow_url} target="_blank" rel="noopener noreferrer">
                  <img src={propertyData.image_url} alt="Property" style={{ width: '200px', height: '150px', objectFit: 'cover', borderRadius: '4px', cursor: 'pointer' }} />
                </a>
              )}
              <div style={{ flex: 1 }}>
                <a href={propertyData.zillow_url} target="_blank" rel="noopener noreferrer" style={{ fontSize: '20px', fontWeight: 'bold', color: '#1976d2', textDecoration: 'none' }}>
                  {propertyData.address} ‚Üí
                </a>
                <div style={{ fontSize: '16px', color: '#666', marginTop: '8px' }}>
                  {propertyData.beds} bed ‚Ä¢ {propertyData.baths} bath ‚Ä¢ {propertyData.currentSqft.toLocaleString()} sqft ‚Ä¢ Built {propertyData.yearBuilt}
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginTop: '15px' }}>
                  <div style={{ background: '#e8f5e9', padding: '15px', borderRadius: '4px' }}>
                    <div style={{ fontSize: '12px', color: '#666' }}>Zestimate</div>
                    <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#2e7d32' }}>${propertyData.zestimate.toLocaleString()}</div>
                  </div>
                  {propertyData.rent_zestimate > 0 && (
                    <div style={{ background: '#e3f2fd', padding: '15px', borderRadius: '4px' }}>
                      <div style={{ fontSize: '12px', color: '#666' }}>Rent Zestimate</div>
                      <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1976d2' }}>${propertyData.rent_zestimate.toLocaleString()}/mo</div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>

          {compsData.length > 0 && (
            <div style={{ background: '#fff3e0', padding: '20px', borderRadius: '8px', marginBottom: '20px' }}>
              <h2 style={{ marginTop: 0 }}>Comparable Sales ({compsData.length})</h2>
              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>
                  <thead>
                    <tr style={{ background: '#f5f5f5' }}>
                      <th style={{ padding: '10px', textAlign: 'left' }}>Property</th>
                      <th style={{ padding: '10px', textAlign: 'center' }}>Distance</th>
                      <th style={{ padding: '10px', textAlign: 'right' }}>Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    {compsData.slice(0, 10).map((comp, idx) => (
                      <tr key={idx} style={{ borderBottom: '1px solid #eee' }}>
                        <td style={{ padding: '10px' }}>{comp.address}</td>
                        <td style={{ padding: '10px', textAlign: 'center' }}>{comp.distance_miles} mi</td>
                        <td style={{ padding: '10px', textAlign: 'right' }}>${comp.price.toLocaleString()}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          <div style={{ background: '#f8f9fa', padding: '20px', borderRadius: '8px', marginBottom: '20px' }}>
            <h3>Enter Purchase Price to Analyze</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr auto', gap: '15px', alignItems: 'end' }}>
              <input name="purchasePrice" type="number" value={propertyData.purchasePrice} onChange={handleInputChange} placeholder="250000" style={{ width: '100%', padding: '12px', borderRadius: '4px', border: '1px solid #ddd' }} />
              <button onClick={analyzeProperty} disabled={loading || !propertyData.purchasePrice} style={{ padding: '12px 30px', background: '#3498db', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                {loading ? 'Analyzing...' : 'Run Analysis'}
              </button>
            </div>
          </div>
        </>
      )}

      {error && <div style={{ background: '#fee', padding: '15px', borderRadius: '8px', color: '#c33', marginBottom: '20px' }}>{error}</div>}

      {results && (
        <div style={{ background: '#fff3e0', padding: '20px', borderRadius: '8px' }}>
          <h2>Analysis Results</h2>
          <div style={{ fontSize: '24px', fontWeight: 'bold' }}>{results.best_scenario.name}</div>
          <div style={{ fontSize: '18px' }}>ROI: {results.best_scenario.roi}%</div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<RealEstateAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
