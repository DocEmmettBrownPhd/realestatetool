<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Analyzer</title>
    <script>
      (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyBx-GxqNHFZ0Hg7csJuucTqK8GZVDc9yPg",
        v: "weekly"
      });
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useRef } = React;

const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000' : '';

function RealEstateAnalyzer() {
  const [propertyData, setPropertyData] = useState({
    address: '',
    purchasePrice: '',
    currentSqft: '',
    beds: '3',
    baths: '2',
    lotSize: '0.25',
    yearBuilt: '2000',
    zestimate: 0,
    rent_zestimate: 0,
    latitude: null,
    longitude: null,
    zillow_url: '',
    image_url: '',
    status: ''
  });
  
  const [compsData, setCompsData] = useState([]);
  const [results, setResults] = useState(null);
  const [loading, setLoading] = useState(false);
  const [fetchingProperty, setFetchingProperty] = useState(false);
  const [error, setError] = useState(null);
  const addressInputRef = useRef(null);
  const autocompleteRef = useRef(null);

  useEffect(() => {
    const initAutocomplete = async () => {
      try {
        const { Autocomplete } = await google.maps.importLibrary("places");
        
        if (addressInputRef.current) {
          autocompleteRef.current = new Autocomplete(addressInputRef.current, {
            types: ['address'],
            componentRestrictions: { country: 'us' },
            fields: ['formatted_address', 'geometry']
          });

          // Handle selection via Click or Enter
          autocompleteRef.current.addListener('place_changed', () => {
            const place = autocompleteRef.current.getPlace();
            
            if (place && place.formatted_address) {
              handleAddressSelection(place.formatted_address);
            }
          });

          // Prevent page refresh but allow "Enter" to pick the top result
          addressInputRef.current.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              // If the dropdown is open, Google handles it. 
              // If not, we prevent the browser from reloading the page.
              const googleDropdown = document.querySelector('.pac-container');
              if (googleDropdown && googleDropdown.style.display !== 'none') {
                // Let Google's library handle the Enter key to select the item
              } else {
                e.preventDefault();
              }
            }
          });
        }
      } catch (err) {
        console.error("Google Maps Initialization Error:", err);
      }
    };

    initAutocomplete();
  }, []);

  const handleAddressSelection = (selectedAddress) => {
    // 1. Visually update the input
    if (addressInputRef.current) addressInputRef.current.value = selectedAddress;
    
    // 2. Update React state
    setPropertyData(prev => ({ ...prev, address: selectedAddress }));
    
    // 3. Kick off the backend search
    fetchPropertyAndComps(selectedAddress);
  };

  const fetchPropertyAndComps = async (address) => {
    setFetchingProperty(true);
    setError(null);
    setCompsData([]);
    
    try {
      const response = await fetch(`${API_URL}/api/lookup-property`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address })
      });
      
      const data = await response.json();
      
      if (response.ok && data.subject) {
        const subject = data.subject;
        setPropertyData(prev => ({
          ...prev,
          address: address,
          currentSqft: subject.sqft || prev.currentSqft,
          beds: subject.beds || prev.beds,
          baths: subject.baths || prev.baths,
          lotSize: subject.lot_size || prev.lotSize,
          yearBuilt: subject.year_built || prev.yearBuilt,
          zestimate: subject.zestimate || 0,
          rent_zestimate: subject.rent_zestimate || 0,
          latitude: subject.latitude,
          longitude: subject.longitude,
          zipcode: subject.zipcode,
          zillow_url: subject.zillow_url || '',
          image_url: subject.image_url || '',
          status: subject.status || ''
        }));
        setCompsData(data.comps || []);
      } else {
        setError('Address recognized by Google, but no real estate data found in database.');
      }
    } catch (err) {
      setError('Backend connection failed. Is your Python server running?');
    } finally {
      setFetchingProperty(false);
    }
  };

  const handleInputChange = (e) => {
    setPropertyData({ ...propertyData, [e.target.name]: e.target.value });
  };

  const analyzeProperty = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch(`${API_URL}/api/analyze`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...propertyData, comps: compsData })
      });
      const data = await response.json();
      if (response.ok) setResults(data);
      else setError(data.error || 'Analysis failed');
    } catch (err) {
      setError('Analysis server connection error.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ maxWidth: '1000px', margin: '40px auto', padding: '20px', fontFamily: 'sans-serif' }}>
      <h1 style={{ textAlign: 'center' }}>Real Estate Investment Analyzer</h1>
      
      <div style={{ background: '#f4f4f4', padding: '20px', borderRadius: '8px' }}>
        <label style={{ fontWeight: 'bold' }}>Search Property Address</label>
        <input
          ref={addressInputRef}
          placeholder="Enter address and press Enter or select from list..."
          style={{ width: '100%', padding: '15px', marginTop: '10px', fontSize: '16px', borderRadius: '4px', border: '1px solid #ccc' }}
        />
        {fetchingProperty && <p style={{ color: 'blue' }}>‚è≥ Fetching property and comp data...</p>}
      </div>

      {error && <div style={{ color: 'red', marginTop: '20px', padding: '10px', background: '#ffdada' }}>{error}</div>}

      {propertyData.zestimate > 0 && (
        <div style={{ marginTop: '20px', border: '1px solid #ddd', padding: '20px' }}>
          <h3>Property Found: {propertyData.address}</h3>
          <p>Zestimate: <strong>${propertyData.zestimate.toLocaleString()}</strong></p>
          <p>Beds: {propertyData.beds} | Baths: {propertyData.baths} | Sqft: {propertyData.currentSqft}</p>
          
          <div style={{ marginTop: '20px' }}>
            <label>Purchase Price ($)</label><br/>
            <input 
              name="purchasePrice" 
              type="number" 
              onChange={handleInputChange} 
              style={{ padding: '10px', width: '200px', marginRight: '10px' }} 
            />
            <button onClick={analyzeProperty} style={{ padding: '10px 20px', cursor: 'pointer' }}>
              {loading ? 'Analyzing...' : 'Analyze Investment'}
            </button>
          </div>
        </div>
      )}

      {results && (
        <div style={{ marginTop: '20px', background: '#e7ffe7', padding: '20px' }}>
          <h2>Result: {results.best_scenario?.name}</h2>
          <p>ROI: {results.best_scenario?.roi}%</p>
        </div>
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<RealEstateAnalyzer />);
    </script>
</body>
</html>
